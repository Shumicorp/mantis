version: 0.2
phases:
  install:
    runtime-versions:
       php: 7.3
    commands:
      - aws eks update-kubeconfig --name my-claster
      - mkdir /sql_data
      - cp -R ./sql_data/ /sql_data
      - composer install

  pre_build:
    commands:
      - docker run --name=msq -d -p 3306:3306 -v /sql_data/sql_data:/var/lib/mysql public.ecr.aws/u1z6d6v5/build-test-db
      - chmod 777 ./build/*.sh
      - sleep 10
  build:
    commands:
      - ./build/b1.sh
      - ./build/b2.sh
      - rm ./config/config_inc.php
      - curl https://my-myntis.s3.eu-central-1.amazonaws.com/config_inc.php >> ./config/config_inc.php
      - aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/u1z6d6v5
      - docker build -t public.ecr.aws/u1z6d6v5/mantis:$CODEBUILD_BUILD_NUMBER -t public.ecr.aws/u1z6d6v5/mantis:latest .
      - docker push public.ecr.aws/u1z6d6v5/mantis:$CODEBUILD_BUILD_NUMBER
      - docker push public.ecr.aws/u1z6d6v5/mantis:latest
      - kubectl apply -f app-k8s.yaml
  post_build:
    commands:
      - docker rm -f msq
